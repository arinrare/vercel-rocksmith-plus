{% extends "base.html" %}

{% block title %}Recommendations - Rocksmith+{% endblock %}

{% block content %}
    <section class="recommendations-section">
        <h1>Recommendations</h1>
        
        <div class="input-options">
            <div class="option-buttons">
                <button id="showBandForm" class="option-btn active">By Favorite Bands</button>
                <button id="showGenreForm" class="option-btn">By Genre Weights</button>
            </div>

            <!-- Band-based form -->
            <form id="bandForm" class="input-form">
                <h4><div class="form-info">Band Selection</div></h4>
                <div class="form-info">Add any bands you like and select their closest genre(s)</div>
                <div id="bandInputs">
                    <div class="band-input">
                        <input type="text" placeholder="Enter band name" required>
                        <div class="genre-selects">
                            <select required class="primary-genre">
                                <option value="">*Primary</option>
                                <option value="alternative">Alternative</option>
                                <option value="blues">Blues</option>
                                <option value="childrens music">Children's Music</option>
                                <option value="classical">Classical</option>
                                <option value="comedy">Comedy</option>
                                <option value="country">Country</option>
                                <option value="electronic">Electronic</option>
                                <option value="folk">Folk</option>
                                <option value="hip-hop">Hip-Hop</option>
                                <option value="holiday music">Holiday Music</option>
                                <option value="indie">Indie</option>
                                <option value="jazz">Jazz</option>
                                <option value="latin">Latin</option>
                                <option value="metal">Metal</option>
                                <option value="new age">New Age</option>
                                <option value="other">Other</option>
                                <option value="pop">Pop</option>
                                <option value="punk">Punk</option>
                                <option value="punk rock">Punk Rock</option>
                                <option value="r&b">R&B</option>
                                <option value="reggae">Reggae</option>
                                <option value="regional music">Regional Music</option>
                                <option value="rock">Rock</option>
                                <option value="sacred music">Sacred Music</option>
                                <option value="stage & screen">Stage & Screen</option>
                            </select>
                            <select class="secondary-genre">
                                <option value="">*Primary</option>
                                <option value="alternative">Alternative</option>
                                <option value="blues">Blues</option>
                                <option value="childrens music">Children's Music</option>
                                <option value="classical">Classical</option>
                                <option value="comedy">Comedy</option>
                                <option value="country">Country</option>
                                <option value="electronic">Electronic</option>
                                <option value="folk">Folk</option>
                                <option value="hip-hop">Hip-Hop</option>
                                <option value="holiday music">Holiday Music</option>
                                <option value="indie">Indie</option>
                                <option value="jazz">Jazz</option>
                                <option value="latin">Latin</option>
                                <option value="metal">Metal</option>
                                <option value="new age">New Age</option>
                                <option value="other">Other</option>
                                <option value="pop">Pop</option>
                                <option value="punk">Punk</option>
                                <option value="punk rock">Punk Rock</option>
                                <option value="r&b">R&B</option>
                                <option value="reggae">Reggae</option>
                                <option value="regional music">Regional Music</option>
                                <option value="rock">Rock</option>
                                <option value="sacred music">Sacred Music</option>
                                <option value="stage & screen">Stage & Screen</option>
                            </select>
                            <select class="tertiary-genre">
                                <option value="">*Primary</option>
                                <option value="alternative">Alternative</option>
                                <option value="blues">Blues</option>
                                <option value="childrens music">Children's Music</option>
                                <option value="classical">Classical</option>
                                <option value="comedy">Comedy</option>
                                <option value="country">Country</option>
                                <option value="electronic">Electronic</option>
                                <option value="folk">Folk</option>
                                <option value="hip-hop">Hip-Hop</option>
                                <option value="holiday music">Holiday Music</option>
                                <option value="indie">Indie</option>
                                <option value="jazz">Jazz</option>
                                <option value="latin">Latin</option>
                                <option value="metal">Metal</option>
                                <option value="new age">New Age</option>
                                <option value="other">Other</option>
                                <option value="pop">Pop</option>
                                <option value="punk">Punk</option>
                                <option value="punk rock">Punk Rock</option>
                                <option value="r&b">R&B</option>
                                <option value="reggae">Reggae</option>
                                <option value="regional music">Regional Music</option>
                                <option value="rock">Rock</option>
                                <option value="sacred music">Sacred Music</option>
                                <option value="stage & screen">Stage & Screen</option>
                            </select>
                        </div>
                        <button type="button" class="remove-btn" hidden>×</button>
                    </div>
                </div>
                <button type="button" id="addBand" class="add-btn">Add Another Band</button>
                <button type="submit" class="submit-btn">Get Recommendations</button>
            </form>

            <!-- Genre-based form -->
            <form id="genreForm" class="input-form" hidden>
                <h4><div class="form-info">Genre Weights</div></h4>
                <div class="form-info">Each genre can only be selected once</div>
                <div id="genreInputs">
                    <div id="genreInputs">
                        <div class="genre-input">
                            <select required>
                                <option value="">*Primary</option>
                                <option value="alternative">Alternative</option>
                                <option value="blues">Blues</option>
                                <option value="childrens music">Children's Music</option>
                                <option value="classical">Classical</option>
                                <option value="comedy">Comedy</option>
                                <option value="country">Country</option>
                                <option value="electronic">Electronic</option>
                                <option value="folk">Folk</option>
                                <option value="hip-hop">Hip-Hop</option>
                                <option value="holiday music">Holiday Music</option>
                                <option value="indie">Indie</option>
                                <option value="jazz">Jazz</option>
                                <option value="latin">Latin</option>
                                <option value="metal">Metal</option>
                                <option value="new age">New Age</option>
                                <option value="other">Other</option>
                                <option value="pop">Pop</option>
                                <option value="punk">Punk</option>
                                <option value="punk rock">Punk Rock</option>
                                <option value="r&b">R&B</option>
                                <option value="reggae">Reggae</option>
                                <option value="regional music">Regional Music</option>
                                <option value="rock">Rock</option>
                                <option value="sacred music">Sacred Music</option>
                                <option value="stage & screen">Stage & Screen</option>
                            </select>
                            <input type="number" min="0" max="100" placeholder="Weight 0-100" required>
                            <button type="button" class="remove-btn" hidden>×</button>
                        </div>
                    </div>
                </div>
                <button type="button" id="addGenre" class="add-btn">Add Another Genre</button>
                <div class="results-control">
                    <label for="numSongs"># Songs (20-500):</label>
                    <input type="number" id="numSongs" min="20" max="500" step="20" value="20">
                    <span class="help-text">Results will load 20 at a time</span>
                </div>
                <button type="submit" class="submit-btn">Get Recommendations</button>
            </form>
        </div>
        <div class="recommendations-container">
            <h2>Song Recommendations</h2>
            <div class="table-wrapper">
                <table id="songs-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Artist</th>
                            <th>Genres</th>
                            <th>Arrangements</th>
                        </tr>
                    </thead>
                    <tbody id="songs-grid">
                        <!-- Songs will be loaded here -->
                    </tbody>
                </table>
                <div class="pagination-controls">
                    <button id="firstPage" class="page-btn" disabled>⟪ First</button>
                    <button id="prevPage" class="page-btn" disabled>⟨ Previous</button>
                    <span class="page-info">Page <span id="currentPageNum">1</span> of <span id="totalPages">1</span></span>
                    <button id="nextPage" class="page-btn" disabled>Next ⟩</button>
                    <button id="lastPage" class="page-btn" disabled>Last ⟫</button>
                </div>
            </div>
        </div>
    </section>
    <script>
        let currentPage = 1;
        let totalSongs = 0;
        let isLoading = false;
        let pageSize = 20;
        const API_PREFIX = window.location.hostname === '127.0.0.1' ? '' : '/rocksmith-plus';
    
        // Form submission handlers
        document.getElementById('bandForm').addEventListener('submit', handleFormSubmit);
        document.getElementById('genreForm').addEventListener('submit', handleFormSubmit);
    
        function handleFormSubmit(e) {
            e.preventDefault();
            currentPage = 1;
    
            // Check if any genre has a weight
            let hasWeight = false;
            if (e.target.id === 'genreForm') {
                const weights = e.target.querySelectorAll('input[type="number"]');
                weights.forEach(weight => {
                    if (weight.value > 0) hasWeight = true;
                });
                
                if (!hasWeight) {
                    alert('Please add at least one genre with a weight greater than 0');
                    return;
                }
            }
    
            // Get form data
            const data = collectFormData(e.target);
            data.page = currentPage;
            data.perPage = pageSize;
    
            fetchSongs(data, true);
        }
    
        function collectFormData(form) {
            const data = {
                formType: form.id,
                genres: [],
                totalRequested: parseInt(document.getElementById('numSongs').value || 500)
            };
    
            if (form.id === 'genreForm') {
                const genreInputs = form.querySelectorAll('.genre-input');
                genreInputs.forEach(input => {
                    const genre = input.querySelector('select').value;
                    const weight = input.querySelector('input[type="number"]').value;
                    if (genre && weight > 0) {
                        data.genres.push({ genre, weight: parseInt(weight) });
                    }
                });
            } else {
                const bandInputs = form.querySelectorAll('.band-input');
                bandInputs.forEach(input => {
                    const band = input.querySelector('input[type="text"]').value;
                    const primary = input.querySelector('.primary-genre').value;
                    const secondary = input.querySelector('.secondary-genre').value;
                    const tertiary = input.querySelector('.tertiary-genre').value;
                    if (band && primary) {
                        data.genres.push({
                            band,
                            genres: [primary, secondary, tertiary].filter(Boolean)
                        });
                    }
                });
            }
            return data;
        }
    
        function fetchSongs(data, isNewSearch = false) {
            if (isLoading) return;
            isLoading = true;
    
            const grid = document.getElementById('songs-grid');
            
            if (isNewSearch) {
                grid.innerHTML = '<tr><td colspan="4" class="loading">Loading recommendations...</td></tr>';
            }

            console.log('API PREFIX:', API_PREFIX); // Debug info
    
            fetch(`${API_PREFIX}/api/songs_weighted`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    throw new Error(result.error);
                }

                grid.innerHTML = '';
                result.songs.forEach(song => {
                    grid.innerHTML += `
                        <tr>
                            <td>${song.title}</td>
                            <td>${song.artist}</td>
                            <td>${song.genres || '-'}</td>
                            <td>${song.arrangements || '-'}</td>
                        </tr>
                    `;
                });
    
                totalSongs = result.total;
                currentPage = parseInt(result.currentPage) || currentPage; // Make sure we get a number
                
                // Debug info
                console.log('Server response:', {
                    total: result.total,
                    currentPage: result.currentPage,
                    totalPages: Math.ceil(result.total / pageSize)
                });
                
                updatePagination();
                isLoading = false;
            })
            .catch(error => {
                console.error('Error:', error);
                grid.innerHTML = '<tr><td colspan="4" class="error">Error loading recommendations</td></tr>';
                isLoading = false;
            });
        }
    
        function updatePagination() {
            const totalPages = Math.ceil(totalSongs / pageSize);
            document.getElementById('currentPageNum').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            // Update button states
            document.getElementById('firstPage').disabled = currentPage === 1;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
            document.getElementById('lastPage').disabled = currentPage >= totalPages;

            console.log(`Current page: ${currentPage}, Total pages: ${totalPages}`); // Debug info
        }
    
        // Navigation event listeners
        document.getElementById('firstPage').addEventListener('click', () => {
            if (currentPage !== 1) {
                const form = document.querySelector('form:not([hidden])');
                const data = collectFormData(form);
                data.page = 1;
                data.perPage = pageSize;
                fetchSongs(data);
            }
        });
    
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                const form = document.querySelector('form:not([hidden])');
                const data = collectFormData(form);
                data.page = currentPage - 1;
                data.perPage = pageSize;
                fetchSongs(data);
            }
        });
    
        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(totalSongs / pageSize);
            if (currentPage < totalPages) {
                const form = document.querySelector('form:not([hidden])');
                const data = collectFormData(form);
                data.page = currentPage + 1;
                data.perPage = pageSize;
                fetchSongs(data);
            }
        });
    
        document.getElementById('lastPage').addEventListener('click', () => {
            const totalPages = Math.ceil(totalSongs / pageSize);
            if (currentPage !== totalPages) {
                const form = document.querySelector('form:not([hidden])');
                const data = collectFormData(form);
                data.page = totalPages;
                data.perPage = pageSize;
                fetchSongs(data);
            }
        });
    </script>
{% endblock %}